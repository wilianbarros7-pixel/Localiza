<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8"/>
    <title>Kanban Veículos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-image: url('https://img.freepik.com/vetores-gratis/fundo-preto-com-linhas-onduladas_52683-76524.jpg');
            background-size: cover;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            text-align: center;
        }
        #search {
            margin: 20px;
            text-align: center;
        }
        #search input {
            padding: 10px;
            width: 300px;
            font-size: 16px;
        }
        #kanban {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            padding: 20px;
        }
        .column {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 10px;
            width: 18%;
            margin: 10px;
            min-height: 200px;
        }
        .column h2 {
            text-align: center;
        }
        .card {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            cursor: pointer;
        }
        .card.dragging {
            opacity: 0.5;
        }
        .popup {
            position: fixed;
            background-color: white;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 15px;
            width: 350px;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.3s ease-in-out;
            resize: both;
            overflow: auto;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            background-color: #444;
            color: white;
            padding: 8px 15px;
            margin: -15px -15px 15px -15px;
            border-radius: 8px 8px 0 0;
        }
        .popup-header h3 {
            margin: 0;
        }
        .popup-controls span {
            margin-left: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
        }
        .popup-content p {
            margin: 5px 0;
        }
        .popup textarea {
            width: calc(100% - 20px);
            min-height: 100px;
            margin-top: 10px;
            padding: 10px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .minimized-bar {
            background-color: #eee;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            z-index: 1001;
            margin-right: 5px;
            display: inline-block;
            animation: fadeIn 0.3s ease-in-out;
        }
        #minimizedContainer {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 1001;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9) translate(-50%, -50%); }
            to { opacity: 1; transform: scale(1) translate(-50%, -50%); }
        }
    </style>
</head>
<body>
<header>Kanban Veículos</header>
<div id="search">
    <input id="searchInput" onkeyup="searchCards()" placeholder="Buscar por placa, empresa ou dias..." type="text"/>
    <input accept=".csv" id="csvFile" onchange="loadCSV(event)" type="file"/>
</div>
<div id="kanban">
    <div class="column" id="dias90" ondragover="allowDrop(event)" ondrop="drop(event)"><h2>90 Dias</h2></div>
    <div class="column" id="dias50" ondragover="allowDrop(event)" ondrop="drop(event)"><h2>50 Dias</h2></div>
    <div class="column" id="aguardando" ondragover="allowDrop(event)" ondrop="drop(event)"><h2>Aguardando</h2></div>
    <div class="column" id="semRetorno" ondragover="allowDrop(event)" ondrop="drop(event)"><h2>Sem Retorno</h2></div>
    <div class="column" id="tenhoResposta" ondragover="allowDrop(event)" ondrop="drop(event)"><h2>Tenho Resposta</h2></div>
</div>
<footer>
    <button onclick="confirmExit()">Fechar Sistema</button>
    <button onclick="generateReport()">Gerar Relatório</button>
</footer>
<div id="minimizedContainer"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script>
    let allCardsData = [];
    let savedState = {};
    const savedStateKey = 'kanbanState';

    // Salva o estado atual do kanban
    function saveState() {
        const state = {};
        document.querySelectorAll('.column').forEach(column => {
            const columnId = column.id;
            state[columnId] = Array.from(column.querySelectorAll('.card')).map(card => {
                const placa = card.dataset.placa;
                const obsElement = document.getElementById(`obs-${placa}`);
                const obs = obsElement ? obsElement.value : (savedState[columnId]?.find(c => c.placa === placa)?.obs || '');
                return { placa, obs };
            });
        });
        localStorage.setItem(savedStateKey, JSON.stringify(state));
    }

    // Carrega o estado salvo
    function loadState() {
        const savedStateString = localStorage.getItem(savedStateKey);
        savedState = savedStateString ? JSON.parse(savedStateString) : {};
    }

    // Carrega o arquivo CSV
    function loadCSV(event) {
        const file = event.target.files[0];
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                allCardsData = results.data.filter(item => parseInt(item['DIAS EM REPARO']) >= 50);
                loadState();
                renderCards(allCardsData);
            }
        });
    }

    // Renderiza os cartões na tela
    function renderCards(data) {
        const columns = ['dias90', 'dias50', 'aguardando', 'semRetorno', 'tenhoResposta'];

        columns.forEach(id => {
            document.getElementById(id).innerHTML = `<h2>${document.getElementById(id).querySelector('h2').textContent}</h2>`;
        });
        
        const renderedPlacas = new Set();
        
        if (Object.keys(savedState).length > 0) {
            columns.forEach(columnId => {
                if (savedState[columnId]) {
                    savedState[columnId].forEach(savedCard => {
                        const originalCardData = data.find(item => item.PLACA === savedCard.placa);
                        if (originalCardData && !renderedPlacas.has(savedCard.placa)) {
                            createCard(originalCardData, columnId);
                            renderedPlacas.add(savedCard.placa);
                        }
                    });
                }
            });
        }
        
        data.forEach(item => {
            if (!renderedPlacas.has(item.PLACA)) {
                const dias = parseInt(item['DIAS EM REPARO']);
                let targetColumnId = 'aguardando';
                if (dias >= 90) {
                    targetColumnId = 'dias90';
                } else if (dias >= 50) {
                    targetColumnId = 'dias50';
                } else {
                    return;
                }
                createCard(item, targetColumnId);
            }
        });

        sortCardsInColumns();
    }

    // Cria um único cartão
    function createCard(item, columnId) {
        const card = document.createElement('div');
        card.className = 'card';
        card.setAttribute('draggable', 'true');
        card.setAttribute('data-placa', item.PLACA);
        card.setAttribute('data-dias', item['DIAS EM REPARO']);

        card.innerHTML = `<span class="placa"><strong>Placa:</strong> ${item.PLACA}</span><br>
                          <span><strong>Dias:</strong> ${item['DIAS EM REPARO']}</span><br>
                          <span><strong>Empresa:</strong> ${item['EMPRESA RESP']}</span>`;

        document.getElementById(columnId).appendChild(card);
        
        card.addEventListener('click', () => {
            createPopup(item);
        });

        card.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', item.PLACA);
            setTimeout(() => card.classList.add('dragging'), 0);
        });

        card.addEventListener('dragend', () => {
            card.classList.remove('dragging');
        });
    }

    // Função para criar o pop-up
    function createPopup(item) {
        const existingPopup = document.getElementById(`popup-${item.PLACA}`);
        if (existingPopup) {
            existingPopup.style.display = 'block';
            return;
        }

        const cardElement = document.querySelector(`.card[data-placa="${item.PLACA}"]`);
        const currentColumnId = cardElement?.closest('.column')?.id;
        const savedObs = (savedState[currentColumnId]?.find(card => card.placa === item.PLACA)?.obs) || '';
        
        const popup = document.createElement('div');
        popup.className = 'popup';
        popup.id = `popup-${item.PLACA}`;
        
        const header = document.createElement('div');
        header.className = 'popup-header';
        header.innerHTML = `<h3>${item.PLACA}</h3>
                            <div class="popup-controls">
                                <span onclick="minimizePopup('${item.PLACA}')">_</span>
                                <span onclick="closePopup('${item.PLACA}')">X</span>
                            </div>`;

        const content = document.createElement('div');
        content.className = 'popup-content';
        content.innerHTML = `<p><strong>Dias em reparo:</strong> ${item['DIAS EM REPARO']}</p>
                             <p><strong>Empresa responsável:</strong> ${item['EMPRESA RESP']}</p>
                             <p><strong>Status:</strong> ${item.STATUS || 'N/A'}</p>
                             <h4>Anotações:</h4>
                             <textarea id="obs-${item.PLACA}" placeholder="Adicione suas anotações aqui...">${savedObs}</textarea>`;

        popup.appendChild(header);
        popup.appendChild(content);

        document.body.appendChild(popup);
        makeDraggable(popup);
        popup.style.display = 'block';

        document.getElementById(`obs-${item.PLACA}`).addEventListener('blur', saveState);
    }
    
    // Funções para pop-up
    function minimizePopup(placa) {
        const popup = document.getElementById(`popup-${placa}`);
        popup.style.display = 'none';
        const bar = document.createElement('div');
        bar.className = 'minimized-bar';
        bar.textContent = placa;
        bar.onclick = () => {
            popup.style.display = 'block';
            bar.remove();
        };
        document.getElementById('minimizedContainer').appendChild(bar);
        saveState();
    }

    function closePopup(placa) {
        const obsTextarea = document.getElementById(`obs-${placa}`);
        if (obsTextarea) {
            const cardElement = document.querySelector(`.card[data-placa="${placa}"]`);
            if (cardElement) {
                const currentColumnId = cardElement.closest('.column').id;
                
                if (!savedState[currentColumnId]) {
                    savedState[currentColumnId] = [];
                }
                
                const existingCardIndex = savedState[currentColumnId].findIndex(c => c.placa === placa);
                if (existingCardIndex !== -1) {
                    savedState[currentColumnId][existingCardIndex].obs = obsTextarea.value;
                } else {
                    savedState[currentColumnId].push({ placa: placa, obs: obsTextarea.value });
                }
            }
        }
        localStorage.setItem(savedStateKey, JSON.stringify(savedState));
        document.getElementById(`popup-${placa}`).remove();
    }

    function makeDraggable(el) {
        const header = el.querySelector('.popup-header');
        let offsetX = 0, offsetY = 0, isDragging = false;
        header.addEventListener('mousedown', (e) => {
            isDragging = true;
            offsetX = e.clientX - el.offsetLeft;
            offsetY = e.clientY - el.offsetTop;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });

        function onMouseMove(e) {
            if (isDragging) {
                el.style.left = `${e.clientX - offsetX}px`;
                el.style.top = `${e.clientY - offsetY}px`;
            }
        }

        function onMouseUp() {
            isDragging = false;
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }
    }

    // Lida com o evento de soltar
    function allowDrop(event) {
        event.preventDefault();
    }

    function drop(event) {
        event.preventDefault();
        const placa = event.dataTransfer.getData('text/plain');
        const draggedCard = document.querySelector(`.card[data-placa="${placa}"]`);
        
        const targetColumn = event.target.closest('.column');
        if (targetColumn) {
            targetColumn.appendChild(draggedCard);
            sortCardsInColumns();
        }
        
        saveState();
    }

    // Nova função para ordenar os cartões por dias
    function sortCardsInColumns() {
        document.querySelectorAll('.column').forEach(column => {
            const cards = Array.from(column.querySelectorAll('.card'));
            
            cards.sort((a, b) => {
                return parseInt(b.dataset.dias) - parseInt(a.dataset.dias);
            });
            
            cards.forEach(card => column.appendChild(card));
        });
    }

    // Função de busca que procura em todos os campos
    function searchCards() {
        const query = document.getElementById('searchInput').value.toUpperCase();
        
        document.querySelectorAll('.card').forEach(card => card.style.display = 'none');
        
        if (query === '') {
            document.querySelectorAll('.card').forEach(card => card.style.display = 'block');
            return;
        }

        document.querySelectorAll('.card').forEach(card => {
            const cardText = card.textContent.toUpperCase();
            if (cardText.includes(query)) {
                card.style.display = 'block';
            }
        });
    }

    // Gera o relatório de texto
    function generateReport() {
        const statusMap = {
            'dias90': '90 Dias',
            'dias50': '50 Dias',
            'aguardando': 'Aguardando',
            'semRetorno': 'Sem Retorno',
            'tenhoResposta': 'Tenho Resposta'
        };

        let reportContent = 'Relatório Kanban de Veículos\n\n';

        for (const [columnId, statusName] of Object.entries(statusMap)) {
            const column = document.getElementById(columnId);
            const cards = column.querySelectorAll('.card');
            
            reportContent += `--- ${statusName} (${cards.length} veículos) ---\n`;
            
            if (cards.length > 0) {
                cards.forEach(card => {
                    const placa = card.dataset.placa;
                    const obs = document.getElementById(`obs-${placa}`)?.value.trim() || '';
                    reportContent += `Placa: ${placa}`;
                    if (obs) {
                        reportContent += ` - Anotações: ${obs}`;
                    }
                    reportContent += `\n`;
                });
            } else {
                reportContent += `Nenhum veículo neste status.\n`;
            }
            reportContent += '\n';
        }

        const blob = new Blob([reportContent], { type: 'text/plain' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'relatorio_kanban.txt';
        link.click();
    }

    function confirmExit() {
        if (confirm('Tem certeza que deseja fechar o sistema?')) {
            alert('Sistema encerrado. Você pode fechar a aba.');
        }
    }

    window.onbeforeunload = function() {
        return 'Tem certeza que deseja sair?';
    };

</script>
</body>
</html>